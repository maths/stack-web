name: Link Checker

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  link-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Build site
        run: |
          mkdocs build --strict
      
      - name: Check internal links
        uses: lycheeverse/lychee-action@v1
        with:
          # Check all HTML files in the built site
          args: --verbose --no-progress --exclude-mail './site/**/*.html'
          # Only check internal links on PRs (external links can be flaky)
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Issue on Failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Broken links detected by automated check',
              body: 'The weekly link checker found broken links. Please review the [workflow run](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') for details.',
              labels: ['bug', 'automated']
            })
